# TapSpot 功能说明书

> 基于地理围栏的智能社交打卡平台 - 完整功能文档
> 
> 版本：v1.0 | 更新日期：2026-02-25

---

## 目录

1. [产品概述](#1-产品概述)
2. [用户系统](#2-用户系统)
3. [地图与打卡](#3-地图与打卡)
4. [内容系统](#4-内容系统)
5. [互动系统](#5-互动系统)
6. [消息系统](#6-消息系统)
7. [技术特性](#7-技术特性)
8. [API 接口清单](#8-api-接口清单)

---

## 1. 产品概述

### 1.1 产品定位

TapSpot 是一款**基于地理位置的社交打卡平台**，通过创新的**内容竞争机制**和**实时通讯系统**，让用户在同一时空坐标下分享体验、建立连接。

### 1.2 核心价值

| 价值维度 | 描述 |
|:---|:---|
| **Discover** | 发现身边的精彩地点和优质内容 |
| **Share** | 分享个人体验，记录生活足迹 |
| **Connect** | 与志同道合的用户建立联系 |
| **Chat** | 实时沟通，深度交流 |

### 1.3 目标用户

- 喜欢探索新地点的旅行者
- 热衷分享生活体验的社交用户
- 需要地点推荐的本地生活用户
- 希望建立基于位置社交关系的用户

---

## 2. 用户系统

### 2.1 用户认证

| 功能 | 描述 | 技术实现 |
|:---|:---|:---|
| **用户注册** | 用户名 + 密码注册新账户 | Bcrypt 密码加密存储 |
| **用户登录** | 凭据验证获取访问令牌 | JWT Token 认证 |
| **会话保持** | Token 有效期内自动登录 | JWT 过期时间管理 |
| **安全保护** | 密码加密、Token 验证 | Bcrypt + JWT 双重保护 |

### 2.2 用户资料

| 字段 | 类型 | 说明 |
|:---|:---|:---|
| `username` | string | 唯一用户名（登录用） |
| `nickname` | string | 昵称（可自定义） |
| `avatar` | string | 头像 URL |
| `gender` | enum | 性别（male/female/other） |
| `bio` | text | 个人简介 |
| `created_at` | datetime | 注册时间 |

### 2.3 用户空间

| 功能 | 描述 |
|:---|:---|
| **个人主页** | 展示用户基本信息、打卡统计、获赞总数 |
| **打卡足迹** | 查看用户发布的所有帖子列表 |
| **影响力数据** | 量化展示用户的内容影响力（打卡数、获赞数） |

---

## 3. 地图与打卡

### 3.1 地图功能

| 功能 | 描述 | 技术实现 |
|:---|:---|:---|
| **地图展示** | 基于 Leaflet 的交互式地图 | Leaflet 1.9+ |
| **定位服务** | 一键获取当前位置 | HTML5 Geolocation API |
| **地图选点** | 手动选择目标位置 | 地图点击事件 |
| **缩放控制** | 多级缩放，平滑过渡 | Leaflet 缩放 API |
| **标记聚合** | 根据缩放级别自适应显示 | 动态标记系统 |

### 3.2 地理围栏

| 功能 | 描述 |
|:---|:---|
| **位置验证** | 验证用户打卡位置的真实性 |
| **附近推荐** | 基于当前位置推荐附近地点 |
| **逆地理编码** | 坐标转换为可读地址 |

### 3.3 打卡标记

| 特性 | 描述 |
|:---|:---|
| **分类图标** | 8 种精心设计的分类图标（日常/美食/住宿/购物/景点/交通/娱乐/工作） |
| **个性化标识** | 用户自己的打卡以金色边框高亮显示 |
| **动态加载** | 根据地图视野范围动态加载标记 |

---

## 4. 内容系统

### 4.1 帖子管理

| 操作 | 接口 | 描述 |
|:---|:---|:---|
| **创建帖子** | `POST /api/posts` | 发布新的打卡内容 |
| **查看帖子** | `GET /api/posts/:id` | 获取帖子详情 |
| **帖子列表** | `GET /api/posts` | 支持筛选、搜索、分页 |
| **编辑帖子** | `PUT /api/posts/:id` | 修改自己的帖子内容 |
| **删除帖子** | `DELETE /api/posts/:id` | 删除自己的帖子 |

### 4.2 帖子结构

```json
{
  "id": 1,
  "user_id": 1,
  "title": "帖子标题",
  "content": "帖子内容",
  "type": "美食",
  "location": "详细地址",
  "latitude": 39.9042,
  "longitude": 116.4074,
  "created_at": "2026-02-25T08:00:00Z",
  "like_count": 10,
  "comment_count": 5
}
```

### 4.3 内容分类

| 分类 | 说明 |
|:---|:---|
| 📅 日常 | 日常生活记录 |
| 🍜 美食 | 餐厅、小吃、饮品 |
| 🏨 住宿 | 酒店、民宿、旅馆 |
| 🛍️ 购物 | 商场、店铺、市场 |
| 🏞️ 景点 | 旅游景点、公园、博物馆 |
| 🚇 交通 | 交通枢纽、车站、停车场 |
| 🎭 娱乐 | 电影院、KTV、游乐场 |
| 💼 工作 | 办公地点、创业园区 |

---

## 5. 互动系统

### 5.1 评论系统

| 功能 | 描述 |
|:---|:---|
| **发表评论** | 对帖子发表评论 |
| **回复评论** | 回复其他用户的评论（支持@功能） |
| **删除评论** | 删除自己发表的评论 |
| **评论列表** | 按时间顺序展示评论 |

### 5.2 点赞系统

| 类型 | 描述 |
|:---|:---|
| **帖子点赞** | 对优质帖子表达认可 |
| **评论点赞** | 让有价值的评论脱颖而出 |
| **点赞状态** | 实时显示当前用户的点赞状态 |
| **点赞列表** | 查看自己点赞过的内容 |

### 5.3 最佳评论 PK 机制 ⭐

> **创新功能**：同一帖子下，点赞数最高的评论与帖子本身进行 PK，点赞数更高者获得"最佳内容"标识。

```
┌─────────────────────────────────────────────────────────┐
│                    最佳评论 PK 系统                       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│    📍 帖子点赞数    ⚔️    💬 最高赞评论点赞数            │
│                           ↓                             │
│              点赞数更高者 → 🏆 最佳内容                   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

| 规则 | 说明 |
|:---|:---|
| **PK 触发** | 每次获取帖子详情时自动计算 |
| **获胜条件** | 评论点赞数 > 帖子点赞数 |
| **标识展示** | 获胜内容获得"🏆 最佳内容"标识 |
| **动态更新** | 随点赞数变化实时更新 PK 结果 |

---

## 6. 消息系统

### 6.1 实时聊天

| 特性 | 描述 | 技术实现 |
|:---|:---|:---|
| **WebSocket 通信** | 全双工实时消息传输 | Gorilla WebSocket |
| **消息推送** | 新消息毫秒级触达 | WebSocket Hub |
| **会话管理** | 自动创建/管理用户会话 | 数据库持久化 |
| **历史消息** | 查看完整聊天历史 | 分页加载 |

### 6.2 消息保障机制

```
┌─────────────────────────────────────────────────────────┐
│                  双重消息保障机制                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│   主通道：WebSocket 实时推送 ←───────────────→ 毫秒级触达  │
│                                                         │
│   备用通道：HTTP 轮询（2 秒/次）←────────────→ 确保不丢失   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

| 机制 | 说明 |
|:---|:---|
| **WebSocket 推送** | 首选通道，消息实时到达 |
| **HTTP 轮询** | 每 2 秒轮询一次，作为备用保障 |
| **智能去重** | 消息合并时自动去重，避免重复显示 |
| **断线重连** | WebSocket 断开后自动重连 |

### 6.3 消息功能

| 功能 | 接口 | 描述 |
|:---|:---|:---|
| **会话列表** | `GET /api/conversations` | 获取所有会话列表 |
| **创建会话** | `GET /api/conversations/with?user_id=X` | 与指定用户创建/获取会话 |
| **发送消息** | `POST /api/messages` | 发送私信消息 |
| **获取消息** | `GET /api/conversations/:id/messages` | 获取会话历史消息 |
| **标记已读** | `POST /api/conversations/:id/read` | 标记会话为已读 |
| **未读统计** | `GET /api/messages/unread` | 获取未读消息总数 |

### 6.4 未读提醒

| 特性 | 描述 |
|:---|:---|
| **实时计数** | 实时显示未读消息数量 |
| **会话级统计** | 每个会话独立统计未读数 |
| **全局统计** | 汇总所有会话的未读消息 |
| **已读同步** | 标记已读后实时更新计数 |

---

## 7. 技术特性

### 7.1 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                        Client Layer                          │
│  React 18 + Leaflet + WebSocket Client                      │
└─────────────────────────────────────────────────────────────┘
                              │ HTTP / WebSocket
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        API Gateway                           │
│  Nginx Reverse Proxy (静态资源/API 代理/WebSocket 代理)        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        Backend Layer                         │
│  Go 1.21+ + Gin + GORM + Gorilla WebSocket                  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        Data Layer                            │
│  MySQL 8.0 (用户/帖子/评论/点赞/消息)                         │
└─────────────────────────────────────────────────────────────┘
```

### 7.2 核心技术栈

| 层级 | 技术 | 版本 |
|:---|:---|:---|
| **前端** | React | 18+ |
| **前端** | Leaflet | 1.9+ |
| **前端** | Lucide React | latest |
| **后端** | Go | 1.21+ |
| **后端** | Gin | latest |
| **后端** | GORM | latest |
| **后端** | Gorilla WebSocket | latest |
| **数据库** | MySQL | 8.0+ |
| **网关** | Nginx | 1.20+ |

### 7.3 安全特性

| 特性 | 描述 |
|:---|:---|
| **密码加密** | Bcrypt 加密存储，防止泄露 |
| **Token 认证** | JWT Token 验证，无状态认证 |
| **请求校验** | 所有 API 请求进行身份验证 |
| **数据隔离** | 用户只能操作自己的数据 |

### 7.4 性能优化

| 优化项 | 描述 |
|:---|:---|
| **动态加载** | 地图标记根据视野范围动态加载 |
| **分页查询** | 大数据列表采用分页加载 |
| **连接复用** | WebSocket 长连接减少握手开销 |
| **索引优化** | 数据库关键字段建立索引 |

---

## 8. API 接口清单

### 8.1 认证接口

| 方法 | 路径 | 描述 | 认证 |
|:---|:---|:---|:---|
| POST | `/api/register` | 用户注册 | ❌ |
| POST | `/api/login` | 用户登录 | ❌ |
| GET | `/api/me` | 获取当前用户信息 | ✅ |
| PUT | `/api/me` | 更新用户资料 | ✅ |
| GET | `/api/users/:id` | 获取用户公开信息 | ✅ |
| GET | `/api/users/:id/posts` | 获取用户的帖子 | ✅ |

### 8.2 帖子接口

| 方法 | 路径 | 描述 | 认证 |
|:---|:---|:---|:---|
| GET | `/api/posts` | 获取帖子列表 | ❌ |
| GET | `/api/posts/:id` | 获取帖子详情 | ❌ |
| POST | `/api/posts` | 创建帖子 | ✅ |
| DELETE | `/api/posts/:id` | 删除帖子 | ✅ |
| POST | `/api/posts/:id/like` | 点赞/取消点赞 | ✅ |
| GET | `/api/likes/check` | 检查点赞状态 | ✅ |
| GET | `/api/likes/my` | 获取我的点赞列表 | ✅ |

### 8.3 评论接口

| 方法 | 路径 | 描述 | 认证 |
|:---|:---|:---|:---|
| GET | `/api/posts/:id/comments` | 获取评论列表 | ❌ |
| POST | `/api/posts/:id/comments` | 发表评论 | ✅ |
| DELETE | `/api/comments/:id` | 删除评论 | ✅ |
| POST | `/api/comments/:id/like` | 评论点赞/取消 | ✅ |
| GET | `/api/comments/likes/check` | 检查评论点赞状态 | ✅ |
| GET | `/api/posts/:id/best-comment` | 获取最佳评论 | ❌ |

### 8.4 消息接口

| 方法 | 路径 | 描述 | 认证 |
|:---|:---|:---|:---|
| GET | `/api/conversations` | 获取会话列表 | ✅ |
| GET | `/api/conversations/with` | 获取/创建会话 | ✅ |
| POST | `/api/conversations/:id/read` | 标记会话已读 | ✅ |
| GET | `/api/conversations/:id/messages` | 获取会话消息 | ✅ |
| POST | `/api/messages` | 发送消息 | ✅ |
| GET | `/api/messages/unread` | 获取未读消息数 | ✅ |

### 8.5 地理接口

| 方法 | 路径 | 描述 | 认证 |
|:---|:---|:---|:---|
| GET | `/api/pois` | 搜索附近兴趣点 | ❌ |
| GET | `/api/geocode/reverse` | 逆地理编码 | ❌ |

### 8.6 WebSocket 接口

| 路径 | 描述 | 参数 |
|:---|:---|:---|
| `/api/ws` | WebSocket 连接 | `token=JWT_TOKEN` |

**消息格式：**

```json
{
  "type": "chat",
  "conversation_id": 1,
  "sender_id": 1,
  "receiver_id": 2,
  "content": "消息内容",
  "created_at": "2026-02-25T08:00:00Z"
}
```

---

## 附录

### A. 数据模型 ER 图

详见 [README.md](../README.md#-数据模型)

### B. 部署指南

详见 [README.md](../README.md#-快速部署)

### C. 贡献指南

详见 [CONTRIBUTING.md](../CONTRIBUTING.md)

---

> 文档维护：TapSpot Team  
> 最后更新：2026-02-25
