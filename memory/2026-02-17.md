# 2026-02-17 工作记录

## TapSpot 功能更新

### 用户反馈问题
1. 没有对本人信息的编辑功能
2. 不能点击其他人空间或跳转去看他所有打卡的页面
3. 飞书API权限缺失 - 需要授权 contact:contact.base:readonly

### 已实现功能

#### 后端API (backend/index.js)
- `PUT /api/me` - 更新用户资料（昵称）
- `GET /api/users/:id` - 获取用户公开信息（含帖子数、获赞数）
- `GET /api/users/:id/posts` - 获取用户的帖子列表

#### 前端功能 (frontend/src/App.jsx)
1. **个人资料编辑**
   - 用户菜单添加「编辑资料」选项
   - 弹窗可修改昵称（用户名不可改）

2. **用户空间**
   - 点击用户名/头像查看用户空间
   - 显示：昵称、用户名、打卡数、获赞数
   - 显示该用户所有打卡记录
   - 点击打卡记录跳转到地图位置

### 部署状态
- 后端运行在 localhost:3002 ✅
- 前端运行在 localhost:3000 ✅
- 代码已推送到 GitHub momo 分支 ✅

### 飞书权限
用户需要管理员授权 contact:contact.base:readonly 权限才能使用通讯录相关功能
授权链接: https://open.feishu.cn/app/cli_a90adf46f5b89cca/auth?q=contact:contact.base:readonly

---

## 用户资料功能完善 (14:55)

### 用户反馈
"编辑功能没有性别那些不好，帮我完善一下这个信息"

### 数据库更新
```sql
ALTER TABLE tapspot.users 
ADD COLUMN gender ENUM('male', 'female', 'secret') DEFAULT 'secret',
ADD COLUMN bio TEXT DEFAULT NULL;
```

### 后端更新
- JWT中间件返回 gender, bio 字段
- PUT /api/me 支持 gender, bio 更新
- GET /api/users/:id 返回 gender, bio

### 前端更新
- 编辑资料弹窗:
  - 头像预览区域
  - 性别选择（男/女/保密）带图标
  - 个人简介输入框（最多200字）
  - 字数统计
- 用户空间展示性别图标和个人简介

---

## 地图定位Bug修复 (23:15)

### 用户反馈
"点击左边的打卡列表，虽然地图定位到对应的数据，但是移动到地图后，又不知道移动到哪里去了"

### 问题分析
点击帖子后调用 setView，但地图的 click 事件也会触发，导致打开发帖弹窗并重置位置

### 修复方案
1. 添加 `navigatingToPost` 状态标志
2. 点击帖子时设置标志，阻止地图点击事件
3. 500ms 后重置标志
4. 添加 `e.stopPropagation()` 阻止事件冒泡
5. 提高缩放级别到 13
